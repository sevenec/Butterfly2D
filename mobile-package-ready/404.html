<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover" />
    <title>Butterfly Nebula Brawl</title>

    <link rel="icon" href="./favicon.ico" />
    <link rel="manifest" href="./manifest.json" />

    <!-- CSS: exact hashed filename from /static/css/ -->
    <link rel="stylesheet" href="./static/css/main.11854c12.css" />

    <!-- Pause overlay style -->
    <style>
      #bnb-pause-overlay {
        position: fixed; inset: 0;
        display: none; align-items: center; justify-content: center;
        background: rgba(0,0,0,0.55);
        font: 700 48px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
        color: #fff; z-index: 999999;
        text-align: center;
      }
      #bnb-pause-overlay .sub {
        font-weight: 500; font-size: 18px; opacity: 0.9; margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <!-- Core engine scripts (must load before main bundle) -->
    <script defer src="./game/AudioManager.js"></script>
    <script defer src="./game/GameRenderer.js"></script>
    <script defer src="./game/inputHandler.js"></script>
    <script defer src="./game/player.js"></script>
    <script defer src="./game/GameEngine.js"></script>

    <!-- Strong default seed to avoid undefined (player/selectedFlutterer/special) -->
    <script>
      (function () {
        try {
          const DEFAULT_FLUTTERER = {
            id: "basic_cosmic_flutter",
            name: "Basic Cosmic Flutterer",
            rarity: "common",
            stats: { speed: 1, health: 1 },
            special: null
          };

          const DEFAULT_PLAYER = {
            name: "Player",
            coins: 0,
            bestScore: 0,
            special: null,
            flutterer: DEFAULT_FLUTTERER
          };

          const ensure = (k, v) => { if (!localStorage.getItem(k)) localStorage.setItem(k, JSON.stringify(v)); };

          // Seed multiple likely keys the game may read
          ensure("bnb.selectedFlutterer", DEFAULT_FLUTTERER);
          ensure("selectedFlutterer", DEFAULT_FLUTTERER);
          ensure("bnb.player", DEFAULT_PLAYER);
          ensure("player", DEFAULT_PLAYER);
          ensure("bnb.profile", DEFAULT_PLAYER);
          ensure("profile", DEFAULT_PLAYER);
        } catch (e) {}
      })();
    </script>

    <!-- Pause/Resume with 3-2-1 countdown; binds to UI buttons if present; hotkey 'P' (desktop) -->
    <script>
      (function () {
        const OVERLAY_ID = "bnb-pause-overlay";
        let paused = false, holdFrames = false, countdownTimer = null;

        const overlay = document.createElement("div");
        overlay.id = OVERLAY_ID;
        overlay.innerHTML = '<div><div>PAUSED</div><div class="sub" id="bnb-countdown"></div></div>';
        document.addEventListener("DOMContentLoaded", () => document.body.appendChild(overlay));

        const _raf = window.requestAnimationFrame.bind(window);
        window.requestAnimationFrame = (cb) => (paused || holdFrames) ? _raf(() => {}) : _raf(cb);

        function showOverlay(msg){const el=document.getElementById(OVERLAY_ID); if(!el) return;
          el.style.display="flex"; const cd=document.getElementById("bnb-countdown"); if(cd) cd.textContent=msg||"Press Resume";}
        function hideOverlay(){const el=document.getElementById(OVERLAY_ID); if(el) el.style.display="none";}
        function pauseGame(){paused=true; showOverlay("");}
        function resumeGameWithCountdown(){
          let n=3; holdFrames=true; paused=false; showOverlay(String(n));
          clearInterval(countdownTimer);
          countdownTimer=setInterval(()=>{ n--; if(n<=0){ clearInterval(countdownTimer); holdFrames=false; hideOverlay(); }
            else { const cd=document.getElementById("bnb-countdown"); if(cd) cd.textContent=String(n); } },1000);
        }

        document.addEventListener("keydown",(e)=>{
          if((e.key||"").toLowerCase()==="p"){
            if(!paused && !holdFrames) pauseGame(); else if(paused) resumeGameWithCountdown();
          }
        });

        const attachButtons=()=>{ const btns=Array.from(document.querySelectorAll("button,[role='button']"));
          const pauseBtn=btns.find(b=>/pause/i.test(b.textContent||"")||/pause/i.test(b.getAttribute("aria-label")||""));
          const resumeBtn=btns.find(b=>/(resume|play)/i.test(b.textContent||"")||/(resume|play)/i.test(b.getAttribute("aria-label")||""));
          if(p
